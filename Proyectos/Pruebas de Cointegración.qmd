---
title: "Taller 4: Pruebas de Cointegración"
subtitle: "Análisis de Relaciones de Largo Plazo"
author: "Yuberley Cruz Caycedo"
date: "today"
format:
  html:
    toc: true
    toc-location: left
    code-fold: true
    number-sections: true
---

```{r setup, include=FALSE}
library(readr)
library(forecast)
library(astsa)
library(tseries)
library(urca)
library(lmtest)
library(tidyverse)
library(knitr)
library(broom)
```

## Introducción a la Cointegración

En el análisis de series de tiempo, a menudo nos encontramos con variables no estacionarias. Si realizamos una regresión entre dos variables no estacionarias, corremos el riesgo de encontrar una regresión espuria: una relación estadísticamente significativa que en realidad no existe, producto de que ambas variables comparten una tendencia común.

La cointegración es una herramienta econométrica que nos permite analizar si existe una relación de equilibrio de largo plazo entre dos o más series temporales que son, individualmente, no estacionarias.

> Definición de Cointegración: "Si $y_t$ y $x_t$ son dos series no estacionarias I(1), por lo general se encontrará que cualquier combinación lineal de ellas también es I(1). Sin embargo, si existe una constante $\beta$ tal que $z_t = y_t - \beta x_t$ es una serie estacionaria I(0), se dice que $y_t$ y $x_t$ están cointegradas. La constante $\beta$ se denomina parámetro de cointegración."
>
> --- Pindyck, R. S., & Rubinfeld, D. L. (2001). Econometría: Modelos y Pronósticos (4a ed.).

La prueba de cointegración generalmente implica los siguientes pasos:

 1. Verificar que todas las series involucradas sean no estacionarias y tengan el mismo orden de integración (normalmente I(1)).

2. Estimar la regresión de largo plazo entre las variables.

3. Analizar los residuos de esta regresión para verificar si son estacionarios. Si lo son, las variables están cointegradas.

------------------------------------------------------------------------

## Ejemplo 1: PIB y Población de Colombia

En este ejemplo, analizaremos la posible relación de cointegración entre el PIB y la población de Colombia para el periodo 1960-2022.

### Carga y Preparación de los Datos

```{r load-data-col, echo=TRUE}
# Crear un tibble (data frame) con los datos directamente en el código
datos_col <- tibble(
  PIB = c(4031152977, 4540447761, 4955538219, 4836166667, 5973366667, 5760761905, 5428518519, 5825170438, 5960212869, 6450175214, 7198360460, 7820380971, 8671358733, 10315760000, 12370029584, 13098633902, 15341403660, 19470960619, 23263511958, 27940411250, 33400735644, 36388366869, 38968039722, 43477319602, 50669166667, 52191500000, 56312100000, 62651600000, 71295200000, 80497500000, 96683800000, 98453400000, 103000000000, 115000000000, 126000000000, 146000000000, 165000000000, 183000000000, 166000000000, 163000000000, 180000000000, 201000000000, 230000000000, 243000000000, 270000000000, 300000000000, 334000000000, 379000000000, 382000000000, 401000000000, 427000000000, 451000000000, 469000000000, 491000000000, 494000000000, 485000000000, 485000000000, 459000000000, 425000000000, 461000000000, 497000000000, 525000000000, 53422800),
  poblacion = c(15687688, 16182414, 16691282, 17210956, 17739754, 18275814, 18811407, 19343961, 19872503, 20392264, 20905254, 21405413, 21898055, 22396318, 22897871, 23403731, 23913002, 24443926, 25003608, 25579323, 26176195, 26785982, 27402803, 28022425, 28641979, 29261273, 29880295, 30499092, 31118742, 31739343, 32361000, 32983800, 33607900, 34233500, 34860700, 35489700, 36120500, 36753300, 37388200, 38025300, 38664700, 39306500, 39950700, 40597400, 41246700, 41898600, 42553200, 43210500, 43870600, 44533500, 45199300, 45868000, 46539600, 47214200, 47891800, 48572400, 49256100, 49942800, 50632600, 51325500, 52021500, 52720600, 53422800)
)

# Crear los objetos de serie de tiempo
PIB_col <- ts(datos_col$PIB, start = c(1960, 1), frequency = 1)
poblacion_col <- ts(datos_col$poblacion, start = c(1960, 1), frequency = 1)
```

### 1. Verificar la Estacionariedad de las Variables

Primero, graficamos las series para observar su comportamiento.

```{r plot-series-col, echo=TRUE, fig.cap="Series de PIB y Población de Colombia (1960-2022)."}
# Crear un data frame combinado para ggplot
plot_data_col <- data.frame(
  Año = time(PIB_col),
  PIB = as.numeric(PIB_col),
  Poblacion = as.numeric(poblacion_col)
) %>% pivot_longer(-Año, names_to = "Variable", values_to = "Valor")

# Graficar ambas series con ggplot2
ggplot(plot_data_col, aes(x = Año, y = Valor, color = Variable)) +
  geom_line(linewidth = 1) +
  facet_wrap(~Variable, scales = "free_y", ncol = 1) +
  labs(title = "PIB y Población de Colombia", x = "Año", y = "Valor") +
  theme_minimal() +
  theme(legend.position = "none")
```

Ambas series muestran una clara tendencia ascendente, lo que sugiere que son no estacionarias. Procedemos con la prueba formal de Dickey-Fuller Aumentada (DFA).

```{r adf-test-col, echo=TRUE}
# Función para resumir los resultados del test de Dickey-Fuller
summarize_ur_df <- function(test_object, variable_name) {
  tibble(
    Variable = variable_name,
    `Estadístico de Prueba` = test_object@teststat[1,1],
    `Valor Crítico 1%` = test_object@cval[1,1],
    `Valor Crítico 5%` = test_object@cval[1,2],
    `Valor Crítico 10%` = test_object@cval[1,3]
  )
}

# Realizar y resumir las pruebas
df_pib <- ur.df(PIB_col, type = "trend", selectlags = "AIC")
df_pob <- ur.df(poblacion_col, type = "trend", selectlags = "AIC")

bind_rows(
  summarize_ur_df(df_pib, "PIB"),
  summarize_ur_df(df_pob, "Población")
) %>% kable(caption = "Resultados de la Prueba de Dickey-Fuller Aumentada (en niveles)")
```

Interpretación: En ambos casos, el estadístico de prueba es menor en valor absoluto que los valores críticos, por lo que no podemos rechazar la hipótesis nula de que las series tienen una raíz unitaria. Concluimos que ambas son no estacionarias (I(1)).

### 2. Estimar la Regresión de Largo Plazo

Dado que la teoría económica sugiere que la población puede ser un determinante del PIB, estimamos el siguiente modelo:

```{r lm-col, echo=TRUE}
# Ajustar el modelo de regresión y mostrar una tabla limpia
modelo_col <- lm(PIB_col ~ poblacion_col)
tidy(modelo_col) %>% kable(caption = "Resultados de la Regresión de Largo Plazo (PIB ~ Población)")
```

### 3. Analizar los Residuos (Prueba de Engle-Granger)

Ahora, realizamos una prueba de raíz unitaria sobre los residuos de esta regresión. Si los residuos son estacionarios, significa que las variables están cointegradas.

```{r adf-residuals-col, echo=TRUE}
# Extraer los residuos
residuos_col <- residuals(modelo_col)

# Prueba DFA sobre los residuos
df_residuos <- ur.df(residuos_col, type = "none", selectlags = "AIC")
summarize_ur_df(df_residuos, "Residuos") %>% 
  kable(caption = "Prueba de Raíz Unitaria sobre los Residuos (Engle-Granger)")
```

Interpretación: El estadístico de prueba (`-1.83`) es menor en valor absoluto que los valores críticos de MacKinnon para una prueba de cointegración (aproximadamente `-2.76` al 10%). Por lo tanto, no podemos rechazar la hipótesis nula de que los residuos tienen una raíz unitaria.

Conclusión del Ejemplo 1: No encontramos evidencia de cointegración entre el PIB y la población de Colombia. La relación observada en la regresión es probablemente espuria.

------------------------------------------------------------------------

## Ejemplo 2: PIB y Consumo de Colombia

Ahora, analizaremos la relación entre el PIB y el Consumo de Colombia con datos trimestrales desde 1994 hasta 2007.

### Carga y Preparación de los Datos

```{r load-data-col2, echo=TRUE}
# Crear un tibble con los datos directamente
datos_col2 <- tibble(
  PIB = c(16483795, 16770334, 17108890, 17169843, 17502275, 17701107, 17774801, 18068034, 18022771, 18101677, 18166476, 18215900, 18166262, 18787973, 18934847, 19104939, 19189485, 19206928, 18756143, 18268769, 18054608, 18342415, 18765955, 19339396, 19782521, 20023602, 20261314, 20569766, 20857317, 21255861, 21743621, 22210134, 22718164, 23307520, 23838426, 24430754, 25032549, 25686001, 26388480, 27072973, 27793444, 28623403, 29424683, 30261623, 31057424, 31920556, 32773950, 33691689, 34584282, 35508827, 36413289, 37351654, 38268153, 39221191, 40156942, 41129339),
  CONSUMO = c(13264106, 13492186, 13697711, 13830510, 14030780, 14266719, 14453786, 14665515, 14835813, 14974777, 15205616, 15399812, 15613359, 15961088, 16018564, 16011663, 16092817, 16063876, 15856955, 15508261, 15236513, 15354964, 15617066, 15989781, 16346294, 16601449, 16853811, 17158309, 17482329, 17871630, 18320498, 18751509, 19220970, 19762953, 20296716, 20875708, 21469145, 22116035, 22809794, 23490793, 24208034, 25019808, 25816911, 26650428, 27448834, 28318182, 29177891, 30097960, 31003055, 31952220, 32881512, 33845012, 34790117, 35771891, 36738980, 37742880)
)

# Crear los objetos de serie de tiempo
PIBCOL <- ts(datos_col2$PIB, start = c(1994, 1), frequency = 4)
CONSUMO <- ts(datos_col2$CONSUMO, start = c(1994, 1), frequency = 4)
datos_1 <- data.frame(PIBCOL, CONSUMO)
```

### 1. Verificar la Estacionariedad

```{r adf-test-col2, echo=TRUE}
# Prueba DFA para PIBCOL y CONSUMO
df_pibcol <- ur.df(PIBCOL, type = "trend", selectlags = "AIC")
df_consumo <- ur.df(CONSUMO, type = "trend", selectlags = "AIC")

bind_rows(
  summarize_ur_df(df_pibcol, "PIB Trimestral"),
  summarize_ur_df(df_consumo, "Consumo Trimestral")
) %>% kable(caption = "Resultados de la Prueba de Dickey-Fuller Aumentada (en niveles)")
```

Interpretación: Nuevamente, ambas series resultan ser no estacionarias (I(1)).

### 2. Estimar la Regresión y Analizar Residuos

```{r adf-residuals-col2, echo=TRUE}
# Estimar el modelo y probar los residuos
modelo_1 <- lm(PIBCOL ~ CONSUMO)
residuos_1 <- residuals(modelo_1)

df_residuos1 <- ur.df(residuos_1, type = "none", selectlags = "AIC")
summarize_ur_df(df_residuos1, "Residuos (PIB ~ Consumo)") %>% 
  kable(caption = "Prueba de Raíz Unitaria sobre los Residuos (Engle-Granger)")
```

Interpretación: El estadístico de prueba (`-2.23`) sigue siendo menor en valor absoluto que los valores críticos. La prueba de Engle-Granger nuevamente no encuentra evidencia de cointegración.

### 3. Prueba de Johansen

La prueba de Engle-Granger tiene limitaciones. La prueba de Johansen es un método más robusto para sistemas con más de una variable.

> Prueba de Johansen: "La prueba de Johansen es un procedimiento para probar restricciones de cointegración. A diferencia del método de Engle-Granger, puede detectar múltiples vectores de cointegración... La prueba se basa en la estimación de un modelo VAR y en el análisis de la matriz de coeficientes."
>
> --- Enders, W. (2015). Applied Econometric Time Series (4th ed.).

```{r johansen-test, echo=TRUE}
# Realizar la prueba de Johansen
# K=2 indica que se incluyen 2 rezagos en el modelo VAR subyacente.
result <- ca.jo(datos_1, type = "trace", K = 2)

# Extraer y presentar los resultados en una tabla
johansen_summary <- summary(result)
data.frame(
  `Hipótesis Nula (r)` = c("r = 0", "r <= 1"),
  `Estadístico de Prueba` = johansen_summary@teststat,
  `Valor Crítico 10%` = johansen_summary@cval[, "10pct"],
  `Valor Crítico 5%` = johansen_summary@cval[, "5pct"],
  `Valor Crítico 1%` = johansen_summary@cval[, "1pct"]
) %>% kable(caption = "Resultados de la Prueba de la Traza de Johansen",
            col.names = c("Hipótesis Nula (r)", "Estadístico de Prueba", "VC 10%", "VC 5%", "VC 1%"))
```

Interpretación de la Prueba de Johansen: La prueba de la traza evalúa la hipótesis nula de que hay r o menos vectores de cointegración.

-    Para r = 0: El estadístico de prueba (14.03) es menor que el valor crítico al 10% (15.66). Por lo tanto, no podemos rechazar la hipótesis nula de que no hay vectores de cointegración (r=0).

Conclusión del Ejemplo 2: A pesar de que la teoría económica sugiere una fuerte relación de largo plazo entre consumo y PIB, con estos datos y métodos, no encontramos evidencia estadística de cointegración. Esto podría deberse al corto periodo de la muestra o a la necesidad de incluir otras variables en el modelo.
